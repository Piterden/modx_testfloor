MODx.grid.TemplateTV=function(config){config=config||{};var tt=new Ext.ux.grid.CheckColumn({header:_('access'),dataIndex:'access',width:70,sortable:false});Ext.applyIf(config,{title:_('template_assignedtv_tab'),id:'modx-grid-template-tv',url:MODx.config.connector_url,fields:['id','name','description','tv_rank','access','perm','category_name','category'],baseParams:{action:'element/template/tv/getlist',template:config.template,sort:'tv_rank'},saveParams:{template:config.template},width:800,paging:true,plugins:tt,remoteSort:true,sortBy:'category_name, tv_rank',grouping:true,groupBy:'category_name',singleText:_('tv'),pluralText:_('tvs'),enableDragDrop:true,ddGroup:'template-tvs-ddsort',sm:new Ext.grid.RowSelectionModel({singleSelect:true,listeners:{beforerowselect:function(sm,idx,keep,record){sm.grid.ddText='<div>'+record.data.name+'</div>';}}}),columns:[{header:_('name'),dataIndex:'name',width:150,editor:{xtype:'textfield',allowBlank:false},sortable:true},{header:_('category'),dataIndex:'category_name',width:150,sortable:true},{header:_('description'),dataIndex:'description',width:350,editor:{xtype:'textfield'},sortable:false},tt,{header:_('rank'),dataIndex:'tv_rank',width:100,editor:{xtype:'textfield',allowBlank:false},sortable:true}],tbar:['->',{xtype:'modx-combo-category',name:'filter_category',hiddenName:'filter_category',id:'modx-temptv-filter-category',emptyText:_('filter_by_category'),value:'',allowBlank:true,width:150,listeners:{'select':{fn:this.filterByCategory,scope:this}}},{xtype:'textfield',name:'search',id:'modx-temptv-search',cls:'x-form-filter',emptyText:_('search_ellipsis'),listeners:{'change':{fn:this.search,scope:this},'render':{fn:function(cmp){new Ext.KeyMap(cmp.getEl(),{key:Ext.EventObject.ENTER,fn:this.blur,scope:cmp});},scope:this}}},{xtype:'button',id:'modx-filter-clear',cls:'x-form-filter-clear',text:_('filter_clear'),listeners:{'click':{fn:this.clearFilter,scope:this}}}]});MODx.grid.TemplateTV.superclass.constructor.call(this,config);this.on('render',this.prepareDDSort,this);};Ext.extend(MODx.grid.TemplateTV,MODx.grid.Grid,{getMenu:function(){var r=this.getSelectionModel().getSelected();var p=r.data.perm;var m=[];if(p.indexOf('pedit')!=-1){m.push({text:_('edit_tv'),handler:this.updateTV});}
return m;},updateTV:function(itm,e){MODx.loadPage('element/tv/update','id='+this.menu.record.id);},filterByCategory:function(cb,rec,ri){this.getStore().baseParams['category']=cb.getValue();this.getBottomToolbar().changePage(1);},search:function(tf,newValue,oldValue){var nv=newValue||tf;this.getStore().baseParams.search=Ext.isEmpty(nv)||Ext.isObject(nv)?'':nv;Ext.getCmp('modx-temptv-filter-category').setValue('');this.getBottomToolbar().changePage(1);return true;},clearFilter:function(){this.getStore().baseParams={action:'element/template/tv/getList',template:this.config.template};Ext.getCmp('modx-temptv-filter-category').reset();Ext.getCmp('modx-temptv-search').setValue('');this.getBottomToolbar().changePage(1);},prepareDDSort:function(grid){this.dropTarget=new Ext.dd.DropTarget(grid.getView().mainBody,{ddGroup:'template-tvs-ddsort',copy:false,notifyOver:function(dragSource,e,data){if(dragSource.getDragData(e)){var targetNode=dragSource.getDragData(e).selections[0];var sourceNode=data.selections[0];if((sourceNode.data['category_name']!=targetNode.data['category_name'])||!sourceNode.data['access']||!targetNode.data['access']||(sourceNode.data['id']==targetNode.data['id'])){return this.dropNotAllowed;}
return this.dropAllowed;}
return this.dropNotAllowed;},notifyDrop:function(dragSource,e,data){if(dragSource.getDragData(e)){var targetNode=dragSource.getDragData(e).selections[0];var sourceNode=data.selections[0];if((targetNode.id!=sourceNode.id)&&(targetNode.get('category_name')===sourceNode.get('category_name'))&&sourceNode.get('access')){grid.sortTVs(sourceNode,targetNode);}}}});},sortTVs:function(sourceNode,targetNode){var store=this.getStore();var sourceIdx=store.indexOf(sourceNode);var targetIdx=store.indexOf(targetNode);store.removeAt(sourceIdx);store.insert(targetIdx,sourceNode);var filteredStore=store.queryBy(function(rec,id){if(rec.get('category_name')===sourceNode.get('category_name')){return true;}
return false;},this);Ext.each(filteredStore.items,function(item,index,allItems){if(sourceNode.get('category_name')===item.get('category_name')){var record=store.getById(item.id);record.set('tv_rank',index);}},this);}});Ext.reg('modx-grid-template-tv',MODx.grid.TemplateTV);;MODx.panel.Template=function(config){config=config||{record:{}};config.record=config.record||{};Ext.applyIf(config,{url:MODx.config.connector_url,baseParams:{action:'element/template/get'},id:'modx-panel-template',cls:'container form-with-labels',class_key:'modTemplate',template:'',bodyStyle:'',items:[{html:'<h2>'+_('template_new')+'</h2>',id:'modx-template-header',cls:'modx-page-header',border:false},MODx.getPageStructure([{title:_('template_title'),defaults:{border:false,msgTarget:'side'},layout:'form',id:'modx-template-form',labelWidth:150,items:[{html:'<p>'+_('template_msg')+'</p>',id:'modx-template-msg',bodyCssClass:'panel-desc'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,cls:'main-wrapper',labelSeparator:''},items:[{columnWidth:.6,items:[{xtype:'hidden',name:'id',id:'modx-template-id',value:config.template},{xtype:'hidden',name:'props',id:'modx-template-props',value:config.record.props||null},{xtype:'textfield',fieldLabel:_('name')+'<span class="required">*</span>',description:MODx.expandHelp?'':_('template_desc_name'),name:'templatename',id:'modx-template-templatename',anchor:'100%',maxLength:100,enableKeyEvents:true,allowBlank:false,value:config.record.templatename,listeners:{'keyup':{scope:this,fn:function(f,e){Ext.getCmp('modx-template-header').getEl().update('<h2>'+_('template')+': '+f.getValue()+'</h2>');}}}},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-template-templatename',html:_('template_desc_name'),cls:'desc-under'},{xtype:'textarea',fieldLabel:_('template_desc'),description:MODx.expandHelp?'':_('template_desc_description'),name:'description',id:'modx-template-description',anchor:'100%',maxLength:255,value:config.record.description||''},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-template-description',html:_('template_desc_description'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('template_icon'),description:MODx.expandHelp?'':_('template_icon_description'),name:'icon',id:'modx-template-icon',anchor:'100%',maxLength:100,enableKeyEvents:true,allowBlank:true,value:config.record.icon},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-template-icon',html:_('template_icon_description'),cls:'desc-under'},{xtype:'modx-combo-browser',browserEl:'modx-browser',fieldLabel:_('static_file'),description:MODx.expandHelp?'':_('static_file_msg'),name:'static_file',openTo:config.record.openTo||'',id:'modx-template-static-file',triggerClass:'x-form-code-trigger',anchor:'100%',maxLength:255,value:config.record.static_file||'',hidden:!config.record['static'],hideMode:'offsets',validator:function(value){if(Ext.getCmp('modx-template-static').getValue()===true){if(Ext.util.Format.trim(value)!=''){return true;}else{return _('static_file_ns');}}
return true;}},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-template-static-file',id:'modx-template-static-file-help',html:_('static_file_msg'),cls:'desc-under',hidden:!config.record['static'],hideMode:'offsets'},{html:MODx.onTempFormRender,border:false}]},{columnWidth:.4,items:[{xtype:'modx-combo-category',fieldLabel:_('category'),description:MODx.expandHelp?'':_('template_desc_category'),name:'category',id:'modx-template-category',anchor:'100%',value:config.record.category||0},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-template-category',html:_('template_desc_category'),cls:'desc-under'},{xtype:'xcheckbox',boxLabel:_('template_lock'),description:_('template_lock_msg'),name:'locked',id:'modx-template-locked',inputValue:1,checked:config.record.locked||false},{xtype:'xcheckbox',boxLabel:_('clear_cache_on_save'),description:_('clear_cache_on_save_msg'),hideLabel:true,name:'clearCache',id:'modx-template-clear-cache',inputValue:1,checked:Ext.isDefined(config.record.clearCache)||true},{xtype:'xcheckbox',hideLabel:true,boxLabel:_('is_static'),description:MODx.expandHelp?'':_('is_static_msg'),name:'static',id:'modx-template-static',inputValue:1,checked:config.record['static']||false},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-template-static',id:'modx-template-static-help',html:_('is_static_msg'),cls:'desc-under'},{xtype:'modx-combo-source',fieldLabel:_('static_source'),description:MODx.expandHelp?'':_('static_source_msg'),name:'source',id:'modx-template-static-source',anchor:'100%',maxLength:255,value:config.record.source!=null?config.record.source:MODx.config.default_media_source,hidden:!config.record['static'],hideMode:'offsets',baseParams:{action:'source/getList',showNone:true,streamsOnly:true},listeners:{select:{fn:this.changeSource,scope:this}}},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-template-static-source',id:'modx-template-static-source-help',html:_('static_source_msg'),cls:'desc-under',hidden:!config.record['static'],hideMode:'offsets'}]}]},{xtype:'panel',border:false,layout:'form',cls:'main-wrapper',labelAlign:'top',items:[{xtype:'textarea',fieldLabel:_('template_code'),name:'content',id:'modx-template-content',anchor:'100%',height:400,value:config.record.content||''}]}]},{xtype:'modx-panel-element-properties',preventRender:true,collapsible:true,elementPanel:'modx-panel-template',elementId:config.template,elementType:'modTemplate',record:config.record},{title:_('template_variables'),itemId:'form-template',defaults:{autoHeight:true},layout:'form',items:[{html:'<p>'+_('template_tv_msg')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-template-tv',cls:'main-wrapper',preventRender:true,anchor:'100%',template:config.template,listeners:{'rowclick':{fn:this.markDirty,scope:this},'afterEdit':{fn:this.markDirty,scope:this},'afterRemoveRow':{fn:this.markDirty,scope:this}}}]}],{id:'modx-template-tabs'})],useLoadingMask:true,listeners:{'setup':{fn:this.setup,scope:this},'success':{fn:this.success,scope:this},'beforeSubmit':{fn:this.beforeSubmit,scope:this}}});MODx.panel.Template.superclass.constructor.call(this,config);var isStatic=Ext.getCmp('modx-template-static');if(isStatic){isStatic.on('check',this.toggleStaticFile);}};Ext.extend(MODx.panel.Template,MODx.FormPanel,{initialized:false,setup:function(){if(this.initialized){this.clearDirty();return true;}
this.getForm().setValues(this.config.record);if(!Ext.isEmpty(this.config.record.templatename)){Ext.getCmp('modx-template-header').getEl().update('<h2>'+_('template')+': '+this.config.record.templatename+'</h2>');}
if(!Ext.isEmpty(this.config.record.properties)){var d=this.config.record.properties;var g=Ext.getCmp('modx-grid-element-properties');if(g){g.defaultProperties=d;g.getStore().loadData(d);}}
this.fireEvent('ready',this.config.record);if(MODx.onLoadEditor){MODx.onLoadEditor(this);}
this.clearDirty();this.initialized=true;MODx.fireEvent('ready');return true;},changeSource:function(){var browser=Ext.getCmp('modx-template-static-file'),source=Ext.getCmp('modx-template-static-source').getValue();browser.config.source=source;},beforeSubmit:function(o){var g=Ext.getCmp('modx-grid-template-tv');Ext.apply(o.form.baseParams,{tvs:g.encodeModified(),propdata:Ext.getCmp('modx-grid-element-properties').encode()});this.cleanupEditor();return this.fireEvent('save',{values:this.getForm().getValues(),stay:MODx.config.stay});},success:function(r){if(MODx.request.id)Ext.getCmp('modx-grid-element-properties').save();Ext.getCmp('modx-grid-template-tv').getStore().commitChanges();this.getForm().setValues(r.result.object);var t=Ext.getCmp('modx-element-tree');if(t){var c=Ext.getCmp('modx-template-category').getValue();var u=c!=''&&c!=null&&c!=0?'n_template_category_'+c:'n_type_template';var node=t.getNodeById('n_template_element_'+Ext.getCmp('modx-template-id').getValue()+'_'+r.result.object.previous_category);if(node)node.destroy();t.refreshNode(u,true);}},changeEditor:function(){this.cleanupEditor();this.on('success',function(o){var id=o.result.object.id;var w=Ext.getCmp('modx-template-which-editor').getValue();MODx.request.a='element/template/update';location.href='?'+Ext.urlEncode(MODx.request)+'&which_editor='+w+'&id='+id;});this.submit();},cleanupEditor:function(){if(MODx.onSaveEditor){var fld=Ext.getCmp('modx-template-content');MODx.onSaveEditor(fld);}},toggleStaticFile:function(cb){var flds=['modx-template-static-file','modx-template-static-file-help','modx-template-static-source','modx-template-static-source-help'];var fld,i;if(cb.checked){for(i in flds){fld=Ext.getCmp(flds[i]);if(fld){fld.show();}}}else{for(i in flds){fld=Ext.getCmp(flds[i]);if(fld){fld.hide();}}}}});Ext.reg('modx-panel-template',MODx.panel.Template);;MODx.page.CreateTemplate=function(config){config=config||{};Ext.applyIf(config,{formpanel:'modx-panel-template',buttons:[{process:'element/template/create',reload:true,text:_('save'),id:'modx-abtn-save',cls:'primary-button',method:'remote',keys:[{key:MODx.config.keymap_save||'s',ctrl:true}]},{text:_('cancel'),id:'modx-abtn-cancel'},{text:_('help_ex'),id:'modx-abtn-help',handler:MODx.loadHelpPane}],components:[{xtype:'modx-panel-template',renderTo:'modx-panel-template-div',template:0,record:config.record||{}}]});MODx.page.CreateTemplate.superclass.constructor.call(this,config);};Ext.extend(MODx.page.CreateTemplate,MODx.Component);Ext.reg('modx-page-template-create',MODx.page.CreateTemplate);