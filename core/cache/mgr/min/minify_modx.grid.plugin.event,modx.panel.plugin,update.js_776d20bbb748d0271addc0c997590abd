MODx.grid.PluginEvent=function(config){config=config||{};this.ident=config.ident||'grid-pluge'+Ext.id();var ec=new Ext.ux.grid.CheckColumn({header:_('enabled'),dataIndex:'enabled',editable:true,width:80,sortable:true});Ext.applyIf(config,{title:_('system_events'),id:'modx-grid-plugin-event',url:MODx.config.connector_url,baseParams:{action:'element/plugin/event/getList',plugin:config.plugin,limit:0},saveParams:{plugin:config.plugin},enableColumnResize:true,enableColumnMove:true,primaryKey:'name',fields:['name','service','groupname','enabled','priority','propertyset','menu'],paging:false,pageSize:0,remoteSort:false,singleText:_('event'),pluralText:_('events'),plugins:ec,columns:[{header:_('name'),dataIndex:'name',id:'modx-'+this.ident+'-col-name',width:250,sortable:true},ec,{header:_('group'),dataIndex:'groupname',id:'modx-'+this.ident+'-col-groupname',width:200,editor:{xtype:'textfield'},sortable:true},{header:_('propertyset'),dataIndex:'propertyset',id:'modx-'+this.ident+'-col-propertyset',width:180,editor:{xtype:'modx-combo-property-set',renderer:true,baseParams:{action:'element/propertyset/getList',showAssociated:true,elementId:config.plugin,elementType:'modPlugin'}},sortable:true},{header:_('priority'),dataIndex:'priority',id:'modx-'+this.ident+'-priority',width:100,editor:{xtype:'textfield',allowBlank:false},sortable:true}]});MODx.grid.PluginEvent.superclass.constructor.call(this,config);this.store.sortInfo={field:'enabled',direction:'DESC'};this.addEvents('updateEvent');};Ext.extend(MODx.grid.PluginEvent,MODx.grid.Grid,{updateEvent:function(btn,e){var r=this.menu.record;if(!this.windows.peu){this.windows.peu=MODx.load({xtype:'modx-window-plugin-event-update',record:r,plugin:this.config.plugin,listeners:{'success':{fn:function(r){this.refresh();this.fireEvent('updateEvent',r);},scope:this}}});}
this.windows.peu.setValues(r);this.windows.peu.show(e.target);}});Ext.reg('modx-grid-plugin-event',MODx.grid.PluginEvent);MODx.window.UpdatePluginEvent=function(config){config=config||{};this.ident=config.ident||'upluge'+Ext.id();Ext.applyIf(config,{title:_('plugin_event_update'),id:'modx-window-plugin-event-update',url:MODx.config.connector_url,action:'element/plugin/event/associate',autoHeight:true,width:600,fields:[{fieldLabel:_('name'),name:'name',id:'modx-'+this.ident+'-name',xtype:'statictextfield',anchor:'100%',submitValue:true},{xtype:'modx-grid-plugin-event-assoc',id:'modx-grid-'+this.ident+'-assoc',autoHeight:true,plugin:config.plugin}]});MODx.window.UpdatePluginEvent.superclass.constructor.call(this,config);this.on('beforeSubmit',this.beforeSubmit,this);};Ext.extend(MODx.window.UpdatePluginEvent,MODx.Window,{onShow:function(){var evt=this.fp.getForm().findField('name').getValue();MODx.Ajax.request({url:MODx.config.connector_url,params:{action:'element/plugin/event/getAssoc','event':evt},listeners:{'success':{fn:function(r){var data=r.results;var g=Ext.getCmp('modx-grid-'+this.ident+'-assoc');var s=g.getStore();s.removeAll();if(data.length>0){s.loadData(data);}},scope:this}}});},beforeSubmit:function(vs){this.fp.getForm().baseParams={action:'element/plugin/event/associate',plugins:Ext.getCmp('modx-grid-'+this.ident+'-assoc').encode()};}});Ext.reg('modx-window-plugin-event-update',MODx.window.UpdatePluginEvent);MODx.grid.PluginEventAssoc=function(config){config=config||{};this.ident=config.ident||'grid-pluge-assoc'+Ext.id();Ext.applyIf(config,{title:_('plugins'),id:this.ident,url:MODx.config.connector_url,baseParams:{action:'element/plugin/event/getPlugins',plugin:config.plugin},saveParams:{plugin:config.plugin},fields:['id','name','priority','propertyset'],pluginRecord:[{name:'id'},{name:'name'},{name:'priority'},{name:'propertyset'}],paging:true,remoteSort:true,columns:[{header:_('id'),dataIndex:'id',width:80,sortable:true},{header:_('plugin'),dataIndex:'name',width:150,sortable:true},{header:_('propertyset'),dataIndex:'propertyset',width:150,editor:{xtype:'modx-combo-property-set',renderer:true,baseParams:{action:'element/propertyset/getList',showAssociated:true,elementId:config.plugin,elementType:'modPlugin'}}},{header:_('priority'),dataIndex:'priority',width:100,editor:{xtype:'textfield',allowBlank:false}}],tbar:[{text:_('plugin_add'),cls:'primary-button',handler:this.addPlugin,scope:this}]});MODx.grid.PluginEventAssoc.superclass.constructor.call(this,config);this.pluginRecord=Ext.data.Record.create(config.pluginRecord);};Ext.extend(MODx.grid.PluginEventAssoc,MODx.grid.LocalGrid,{addPlugin:function(btn,e){this.loadWindow(btn,e,{xtype:'modx-window-plugin-event-add-plugin',record:this.menu.record,plugin:this.config.plugin,listeners:{'success':{fn:function(r){var rec=new this.pluginRecord({id:r.id,name:r.name,priority:r.priority,propertyset:r.propertyset});this.getStore().add(rec);},scope:this}}});},_showMenu:function(g,ri,e){var sm=this.getSelectionModel();e.stopEvent();e.preventDefault();if(!sm.isSelected(ri)){sm.selectRow(ri);}
this.menu.removeAll();this.addContextMenuItem([{text:_('remove'),handler:this.remove.createDelegate(this,[{title:_('warning'),text:_('plugin_event_plugin_remove_confirm')}]),scope:this}]);this.menu.show(e.target);}});Ext.reg('modx-grid-plugin-event-assoc',MODx.grid.PluginEventAssoc);MODx.window.AddPluginToEvent=function(config){config=config||{};this.ident=config.ident||'apluge'+Ext.id();Ext.applyIf(config,{title:_('plugin_add_to_event'),id:this.ident,url:MODx.config.connector_url,action:'element/plugin/event/addplugin',autoHeight:true,fields:[{xtype:'modx-combo-plugin',fieldLabel:_('plugin'),name:'plugin',id:'modx-'+this.ident+'-plugin',anchor:'100%',allowBlank:false},{xtype:'numberfield',name:'priority',fieldLabel:_('priority'),id:'modx-'+this.ident+'-priority',value:0,allowBlank:false,anchor:'100%'}]});MODx.window.AddPluginToEvent.superclass.constructor.call(this,config);};Ext.extend(MODx.window.AddPluginToEvent,MODx.Window,{submit:function(){var f=this.fp.getForm();var vs=f.getValues();var cb=f.findField('plugin');vs.id=cb.getValue();vs.name=cb.getRawValue();if(this.fp.getForm().isValid()){if(this.fireEvent('success',vs)){this.fp.getForm().reset();this.hide();return true;}}
return false;}});Ext.reg('modx-window-plugin-event-add-plugin',MODx.window.AddPluginToEvent);MODx.combo.Plugin=function(config){config=config||{};Ext.applyIf(config,{url:MODx.config.connector_url,baseParams:{action:'element/plugin/getlist'},fields:['id','name','description'],name:'plugin',hiddenName:'plugin',displayField:'name',valueField:'id',editable:false,tpl:new Ext.XTemplate('<tpl for="."><div class="x-combo-list-item"><span style="font-weight: bold">{name}</span>','<br />{description}</div></tpl>')});MODx.combo.Plugin.superclass.constructor.call(this,config);};Ext.extend(MODx.combo.Plugin,MODx.combo.ComboBox);Ext.reg('modx-combo-plugin',MODx.combo.Plugin);;MODx.panel.Plugin=function(config){config=config||{};Ext.applyIf(config,{url:MODx.config.connector_url,baseParams:{action:'element/plugin/get'},id:'modx-panel-plugin',cls:'container form-with-labels',class_key:'modPlugin',plugin:'',bodyStyle:'',allowDrop:false,items:[{html:'<h2>'+_('plugin_new')+'</h2>',id:'modx-plugin-header',cls:'modx-page-header',border:false},MODx.getPageStructure([{title:_('plugin_title'),layout:'form',id:'modx-plugin-form',labelWidth:150,defaults:{border:false,msgTarget:'side'},items:[{html:'<p>'+_('plugin_msg')+'</p>',bodyCssClass:'panel-desc',id:'modx-plugin-msg'},{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false,cls:'main-wrapper',labelSeparator:''},items:[{columnWidth:.6,items:[{xtype:'hidden',name:'id',id:'modx-plugin-id',value:config.record.id||0},{xtype:'hidden',name:'props',id:'modx-plugin-props',value:config.record.props||null},{xtype:'textfield',fieldLabel:_('name')+'<span class="required">*</span>',description:MODx.expandHelp?'':_('plugin_desc_name'),name:'name',id:'modx-plugin-name',anchor:'100%',maxLength:255,enableKeyEvents:true,allowBlank:false,value:config.record.name,listeners:{'keyup':{scope:this,fn:function(f,e){Ext.getCmp('modx-plugin-header').getEl().update('<h2>'+_('plugin')+': '+f.getValue()+'</h2>');}}}},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-plugin-name',html:_('plugin_desc_name'),cls:'desc-under'},{xtype:'textarea',fieldLabel:_('plugin_desc'),description:MODx.expandHelp?'':_('plugin_desc_description'),name:'description',id:'modx-plugin-description',anchor:'100%',maxLength:255,value:config.record.description},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-plugin-description',html:_('plugin_desc_description'),cls:'desc-under'},{xtype:'modx-combo-browser',browserEl:'modx-browser',fieldLabel:_('static_file'),description:MODx.expandHelp?'':_('static_file_msg'),name:'static_file',openTo:config.record.openTo||'',id:'modx-plugin-static-file',triggerClass:'x-form-code-trigger',anchor:'100%',maxLength:255,value:config.record.static_file||'',hidden:!config.record['static'],hideMode:'offsets',validator:function(value){if(Ext.getCmp('modx-plugin-static').getValue()===true){if(Ext.util.Format.trim(value)!=''){return true;}else{return _('static_file_ns');}}
return true;}},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-plugin-static-file',id:'modx-plugin-static-file-help',html:_('static_file_msg'),cls:'desc-under',hidden:!config.record['static'],hideMode:'offsets'},{html:MODx.onPluginFormRender,border:false}]},{columnWidth:.4,items:[{xtype:'modx-combo-category',fieldLabel:_('category'),description:MODx.expandHelp?'':_('plugin_desc_category'),name:'category',id:'modx-plugin-category',anchor:'100%',value:config.record.category||0},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-plugin-category',html:_('plugin_desc_category'),cls:'desc-under'},{xtype:'xcheckbox',hideLabel:true,boxLabel:_('plugin_disabled'),name:'disabled',id:'modx-plugin-disabled',inputValue:1,checked:config.record.disabled||0},{xtype:'xcheckbox',boxLabel:_('plugin_lock'),description:MODx.expandHelp?'':_('plugin_lock_msg'),hideLabel:true,name:'locked',id:'modx-plugin-locked',inputValue:1,checked:config.record.locked||0},{xtype:'xcheckbox',boxLabel:_('clear_cache_on_save'),description:MODx.expandHelp?'':_('clear_cache_on_save_msg'),hideLabel:true,name:'clearCache',id:'modx-plugin-clear-cache',inputValue:1,checked:Ext.isDefined(config.record.clearCache)||true},{xtype:'xcheckbox',hideLabel:true,boxLabel:_('is_static'),description:MODx.expandHelp?'':_('is_static_msg'),name:'static',id:'modx-plugin-static',inputValue:1,checked:config.record['static']||false},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-plugin-static',id:'modx-plugin-static-help',html:_('is_static_msg'),cls:'desc-under'},{xtype:'modx-combo-source',fieldLabel:_('static_source'),description:MODx.expandHelp?'':_('static_source_msg'),name:'source',id:'modx-plugin-static-source',anchor:'100%',maxLength:255,value:config.record.source!=null?config.record.source:MODx.config.default_media_source,hidden:!config.record['static'],hideMode:'offsets',baseParams:{action:'source/getList',showNone:true,streamsOnly:true},listeners:{select:{fn:this.changeSource,scope:this}}},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-plugin-static-source',id:'modx-plugin-static-source-help',html:_('static_source_msg'),cls:'desc-under',hidden:!config.record['static'],hideMode:'offsets'}]}]},{xtype:'panel',border:false,layout:'form',cls:'main-wrapper',labelAlign:'top',items:[{xtype:'textarea',fieldLabel:_('plugin_code'),name:'plugincode',id:'modx-plugin-plugincode',anchor:'100%',height:400,value:config.record.plugincode||"<?php\n"}]}]},{title:_('system_events'),id:'modx-plugin-sysevents',items:[{html:'<p>'+_('plugin_event_msg')+'</p>',id:'modx-plugin-sysevents-msg',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-plugin-event',cls:'main-wrapper',preventRender:true,plugin:config.record.id||0,listeners:{'updateEvent':{fn:this.markDirty,scope:this},'rowclick':{fn:this.markDirty,scope:this}}}]},{xtype:'modx-panel-element-properties',elementPanel:'modx-panel-plugin',elementId:config.plugin,elementType:'modPlugin',record:config.record}],{id:'modx-plugin-tabs'})],useLoadingMask:true,listeners:{'setup':{fn:this.setup,scope:this},'success':{fn:this.success,scope:this},'beforeSubmit':{fn:this.beforeSubmit,scope:this}}});MODx.panel.Plugin.superclass.constructor.call(this,config);var isStatic=Ext.getCmp('modx-plugin-static');if(isStatic){isStatic.on('check',this.toggleStaticFile);}};Ext.extend(MODx.panel.Plugin,MODx.FormPanel,{initialized:false,setup:function(){if(this.initialized){this.clearDirty();return true;}
this.getForm().setValues(this.config.record);if(!Ext.isEmpty(this.config.record.name)){Ext.getCmp('modx-plugin-header').getEl().update('<h2>'+_('plugin')+': '+this.config.record.name+'</h2>');}
if(!Ext.isEmpty(this.config.record.properties)){var d=this.config.record.properties;var g=Ext.getCmp('modx-grid-element-properties');if(g){g.defaultProperties=d;g.getStore().loadData(d);}}
this.fireEvent('ready',this.config.record);if(MODx.onLoadEditor){MODx.onLoadEditor(this);}
this.clearDirty();MODx.fireEvent('ready');this.initialized=true;},changeSource:function(){var browser=Ext.getCmp('modx-plugin-static-file'),source=Ext.getCmp('modx-plugin-static-source').getValue();browser.config.source=source;},beforeSubmit:function(o){var g=Ext.getCmp('modx-grid-plugin-event');Ext.apply(o.form.baseParams,{events:g.encodeModified(),propdata:Ext.getCmp('modx-grid-element-properties').encode()});this.cleanupEditor();return this.fireEvent('save',{values:this.getForm().getValues(),stay:MODx.config.stay});},success:function(o){if(MODx.request.id)Ext.getCmp('modx-grid-element-properties').save();Ext.getCmp('modx-grid-plugin-event').getStore().commitChanges();this.getForm().setValues(o.result.object);var t=Ext.getCmp('modx-element-tree');if(t){var c=Ext.getCmp('modx-plugin-category').getValue();var u=c!=''&&c!=null&&c!=0?'n_plugin_category_'+c:'n_type_plugin';var node=t.getNodeById('n_plugin_element_'+Ext.getCmp('modx-plugin-id').getValue()+'_'+o.result.object.previous_category);if(node)node.destroy();t.refreshNode(u,true);}},changeEditor:function(){this.cleanupEditor();this.on('success',function(o){var id=o.result.object.id;var w=Ext.getCmp('modx-plugin-which-editor').getValue();MODx.request.a='element/plugin/update';location.href='?'+Ext.urlEncode(MODx.request)+'&which_editor='+w+'&id='+id;});this.submit();},cleanupEditor:function(){if(MODx.onSaveEditor){var fld=Ext.getCmp('modx-plugin-plugincode');MODx.onSaveEditor(fld);}},toggleStaticFile:function(cb){var flds=['modx-plugin-static-file','modx-plugin-static-file-help','modx-plugin-static-source','modx-plugin-static-source-help'];var fld,i;if(cb.checked){for(i in flds){fld=Ext.getCmp(flds[i]);if(fld){fld.show();}}}else{for(i in flds){fld=Ext.getCmp(flds[i]);if(fld){fld.hide();}}}}});Ext.reg('modx-panel-plugin',MODx.panel.Plugin);;MODx.page.UpdatePlugin=function(config){config=config||{};Ext.applyIf(config,{formpanel:'modx-panel-plugin',buttons:[{process:'element/plugin/update',text:_('save'),id:'modx-abtn-save',cls:'primary-button',method:'remote',keys:[{key:MODx.config.keymap_save||'s',ctrl:true}]},{text:_('duplicate'),id:'modx-abtn-duplicate',handler:this.duplicate,scope:this},{text:_('cancel'),id:'modx-abtn-cancel'},{text:_('help_ex'),id:'modx-abtn-help',handler:MODx.loadHelpPane}],components:[{xtype:'modx-panel-plugin',renderTo:'modx-panel-plugin-div',plugin:config.record.id||MODx.request.id,record:config.record||{}}]});MODx.page.UpdatePlugin.superclass.constructor.call(this,config);};Ext.extend(MODx.page.UpdatePlugin,MODx.Component,{duplicate:function(btn,e){var rec={id:this.record.id,type:'plugin',name:_('duplicate_of',{name:this.record.name})};var w=MODx.load({xtype:'modx-window-element-duplicate',record:rec,listeners:{success:{fn:function(r){var response=Ext.decode(r.a.response.responseText);MODx.loadPage('element/'+rec.type+'/update','id='+response.object.id);},scope:this},hide:{fn:function(){this.destroy();}}}});w.show(e.target);}});Ext.reg('modx-page-plugin-update',MODx.page.UpdatePlugin);