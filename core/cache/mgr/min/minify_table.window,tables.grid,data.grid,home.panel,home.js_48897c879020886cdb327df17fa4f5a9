dbAdmin.window.UpdateTable=function(config){config=config||{};if(!config.id){config.id='dbadmin-table-window-update';}
Ext.applyIf(config,{title:_('dbadmin_table_properties'),width:400,autoHeight:false,url:dbAdmin.config.connector_url,action:'mgr/tables/update',resizable:false,maximizable:false,fields:this.getFields(config),keys:[{key:Ext.EventObject.ENTER,shift:true,fn:function(){this.submit()},scope:this}]});dbAdmin.window.UpdateTable.superclass.constructor.call(this,config);};Ext.extend(dbAdmin.window.UpdateTable,MODx.Window,{getFields:function(config){return[{xtype:'textfield',fieldLabel:_('dbadmin_table'),name:'name',id:config.id+'dbadmin-table-name',anchor:'100%',allowBlank:false},{xtype:'hidden',name:'oldName'},{xtype:'textfield',fieldLabel:_('dbadmin_package'),name:'package',id:config.id+'dbadmin-table-package',anchor:'100%'},{layout:'column',border:false,style:{marginTop:'10px'},anchor:'100%',items:[{columnWidth:.85,layout:'form',defaults:{msgTarget:'under'},border:false,items:[{xtype:'textfield',fieldLabel:_('dbadmin_class'),name:'class',id:config.id+'dbadmin-table-class',anchor:'100%'}]},{columnWidth:.15,layout:'form',defaults:{msgTarget:'qtip'},style:{marginTop:'5px'},border:false,items:[{xtype:'button',text:'<i class="icon icon-magic"></i>',tooltip:_('dbadmin_table_set_class'),id:config.id+'-getclass-button',cls:'get-class-button',style:{marginTop:'18px',padding:'7px 15px'},scope:this,anchor:'100%',handler:function(){this.getClass(this.config);}}]}]}];},getClass:function(config){var name=Ext.getCmp(config.id+'dbadmin-table-name').getValue('name'),pkg=Ext.getCmp(config.id+'dbadmin-table-package').getValue('package');MODx.Ajax.request({url:dbAdmin.config.connector_url,params:{action:'mgr/tables/setclass',name:name,package:pkg},listeners:{success:{fn:function(r){var className=r.object.class||'';Ext.getCmp(config.id+'dbadmin-table-class').setValue(className);},scope:this},failure:{fn:function(r){},scope:this}}});},});Ext.reg('dbadmin-table-window-update',dbAdmin.window.UpdateTable);;dbAdmin.grid.Tables=function(config){config=config||{};if(!config.id){config.id='dbadmin-grid-tables';}
this.sm=new Ext.grid.CheckboxSelectionModel();Ext.applyIf(config,{url:dbAdmin.config.connector_url,primaryKey:'name',sm:this.sm,fields:['name','class','package','type','rows','collation','size','actions'],columns:[this.sm,{header:_('dbadmin_table'),dataIndex:'name',sortable:true,editable:true,width:300},{header:_('dbadmin_class'),dataIndex:'class',sortable:true,width:150},{header:_('dbadmin_package'),dataIndex:'package',sortable:false,hidden:true,width:100},{header:_('dbadmin_table_type'),dataIndex:'type',sortable:false,fixed:true,width:100},{header:_('dbadmin_table_collation'),dataIndex:'collation',sortable:false,width:100},{header:_('dbadmin_table_rows'),dataIndex:'rows',sortable:false,menuDisabled:true,fixed:true,width:70},{header:_('dbadmin_table_size'),dataIndex:'size',sortable:false,menuDisabled:true,fixed:true,width:90},{header:_('dbadmin_table_actions'),dataIndex:'actions',renderer:dbAdmin.utils.renderActions,sortable:false,width:170,fixed:true,id:'actions'}],tbar:this.getTopBar(config),baseParams:{action:'mgr/tables/getlist'},listeners:{rowDblClick:function(grid,rowIndex,e){var row=grid.store.getAt(rowIndex);this.viewTable(grid,e,row);}},viewConfig:{forceFit:true,enableRowBody:true,autoFill:true,showPreview:true,scrollOffset:0},paging:true,pageSize:25,remoteSort:true,autoHeight:true});dbAdmin.grid.Tables.superclass.constructor.call(this,config);if(config.autosave){this.on('afteredit',this.saveRecord,this);}
this.store.on('load',function(o){if(this._getSelectedIds().length){this.getSelectionModel().clearSelections();}},this);};Ext.extend(dbAdmin.grid.Tables,MODx.grid.Grid,{windows:{},getMenu:function(grid,rowIndex){var ids=this._getSelectedIds();var row=grid.getStore().getAt(rowIndex);var menu=dbAdmin.utils.getMenu(row.data['actions'],this,ids);this.addContextMenuItem(menu);},exportSelected:function(b,o){var export_db,tables='';if(b.id=='dbadmin-db-export'){export_db=true;}else{export_db=false;tables=this.getSelectedAsList();if(tables===false)return false;}
var panel=Ext.getCmp('dbadmin-panel');panel.el.mask(_('working'));MODx.Ajax.request({url:dbAdmin.config.connector_url,params:{action:'mgr/tables/export',tables:tables,export_db:export_db},listeners:{success:{fn:function(r){panel.el.unmask();location.href=this.url+"?action=mgr/tables/download&HTTP_MODAUTH="+MODx.siteId;},scope:this},failure:{fn:function(r){panel.el.unmask();MODx.msg.alert(_('error'),r.message);},scope:this}}});},viewTable:function(grid,e,row){var record=typeof(row)!='undefined'?row.data:this.menu.record;MODx.Ajax.request({url:dbAdmin.config.connector_url,params:{action:'mgr/table/getfields',table:record.name},listeners:{success:{fn:function(r){var fields=r.fields;var colModel=new Ext.grid.ColumnModel({columns:[],defaults:{sortable:true,menuDisabled:true,editable:record.class!='',editor:{xtype:'textfield'},width:70}});for(var i=0;i<fields.length;i++){colModel.columns[i]={header:fields[i]['name'],dataIndex:fields[i]['name']};switch(fields[i]['type']){case'string':colModel.columns[i].editor={xtype:'textarea'};colModel.columns[i].width=100;break;case'number':colModel.columns[i].width=30;break;case'actions':colModel.columns[i].header='<i class="icon icon-cog"></i>';colModel.columns[i].id='actions';colModel.columns[i].sortable=false;colModel.columns[i].width=50;colModel.columns[i].renderer=dbAdmin.utils.renderActions;colModel.columns[i].fixed=true;colModel.columns[i].editable=false;break;}
if(fields[i]['name']=='id'){colModel.columns[i].width=40;colModel.columns[i].fixed=true;}}
colModel.columns[0].menuDisabled=false;if(this.dataGridTable)this.dataGridTable.close();this.dataGridTable=MODx.load({xtype:'dbadmin-table-data-window',table:record.name,class:record.class,package:record.package,gridFields:fields,gridColumns:colModel});this.dataGridTable.show(Ext.EventObject.target);},scope:this},failure:{fn:function(r){MODx.msg.alert(_('error'),r.message);},scope:this}}});},updateTable:function(g,e){var row=this.getSelectionModel().getSelected();if(typeof(row)!='undefined'){this.menu.record=row.data;}
else if(!this.menu.record){return false;}
row.data.oldName=row.data.name;if(!this.updateWindow){this.updateWindow=MODx.load({xtype:'dbadmin-table-window-update',listeners:{success:{fn:function(){this.refresh();},scope:this}}});}
this.updateWindow.reset();this.updateWindow.setValues(row.data);this.updateWindow.show(e.target);},selectQuery:function(){var row=this.getSelectionModel().getSelected();if(typeof(row)!='undefined'){this.menu.record=row.data;}
else if(!this.menu.record){return false;}
MODx.Ajax.request({url:dbAdmin.config.connector_url,params:{action:'mgr/table/getfields',table:row.data.name,forselect:1},listeners:{success:{fn:function(r){var fields=r.fields||'*',query='SELECT '+fields+' FROM `'+row.data.name+'`';Ext.getCmp('dbadmin-sql-query').setValue(query);Ext.getCmp('dbadmin-tabpanel').setActiveTab('dbadmin-sql-tab');},scope:this},failure:{fn:function(r){},scope:this}}});return true;},removeTable:function(){var row=this.getSelectionModel().getSelected();if(typeof(row)!='undefined'){this.menu.record=row.data;}
else if(!this.menu.record){return false;}
var name=row.data.name;MODx.msg.confirm({title:_('dbadmin_table_remove'),text:_('dbadmin_table_remove_confirm'),url:this.config.url,params:{action:'mgr/table/remove',name:name},listeners:{success:{fn:function(r){this.refresh();},scope:this}}});return true;},removeSelected:function(){var tables=this.getSelectedAsList();if(tables===false)return false;MODx.msg.confirm({title:tables.split(',').length>1?_('dbadmin_tables_remove'):_('dbadmin_table_remove'),text:tables.split(',').length>1?_('dbadmin_tables_remove_confirm'):_('dbadmin_table_remove_confirm'),url:this.config.url,params:{action:'mgr/tables/remove',tables:tables},listeners:{success:{fn:function(r){this.refresh();},scope:this}}});return true;},truncateSelected:function(){var tables=this.getSelectedAsList();if(tables===false)return false;MODx.msg.confirm({title:tables.split(',').length>1?_('dbadmin_tables_truncate'):_('dbadmin_table_truncate'),text:tables.split(',').length>1?_('dbadmin_tables_truncate_confirm'):_('dbadmin_table_truncate_confirm'),url:this.config.url,params:{action:'mgr/tables/truncate',tables:tables},listeners:{success:{fn:function(r){this.refresh();},scope:this}}});return true;},getTopBar:function(config){return[{text:_('dbadmin_db_export'),id:'dbadmin-db-export',handler:this.exportSelected,scope:this},{text:_('bulk_actions'),menu:[{text:'<i class="icon icon-download"></i> '+_('dbadmin_selected_export'),id:'dbadmin-menu-selected-export',handler:this.exportSelected,style:{padding:'3px 10px !important;'},scope:this},{text:'<i class="icon icon-eraser"></i> '+_('dbadmin_selected_truncate'),id:'dbadmin-menu-selected-truncate',handler:this.truncateSelected,scope:this},{text:'<i class="icon icon-trash-o"></i> '+_('dbadmin_selected_remove'),id:'dbadmin-menu-selected-remove',handler:this.removeSelected,scope:this}]},'->',{xtype:'textfield',name:'query',width:200,id:config.id+'-search-field',emptyText:_('dbadmin_grid_search'),listeners:{render:{fn:function(tf){tf.getEl().addKeyListener(Ext.EventObject.ENTER,function(){this.search(tf);},this);},scope:this}}},{xtype:'button',id:config.id+'-search-clear',text:'<i class="icon icon-times"></i>',listeners:{click:{fn:this.clearSearch,scope:this}}}];},onClick:function(e){var elem=e.getTarget();if(elem.nodeName=='BUTTON'){var row=this.getSelectionModel().getSelected();if(typeof(row)!='undefined'){var action=elem.getAttribute('action');if(action=='showMenu'){var ri=this.getStore().find('id',row.id);return this._showMenu(this,ri,e);}
else if(typeof this[action]==='function'){this.menu.record=row.data;return this[action](this,e);}}}
return this.processEvent('click',e);},_getSelectedIds:function(){var ids=[];var selected=this.getSelectionModel().getSelections();for(var i in selected){if(!selected.hasOwnProperty(i)){continue;}
ids.push(selected[i]['name']);}
return ids;},search:function(tf,nv,ov){this.getStore().baseParams.query=tf.getValue();this.getBottomToolbar().changePage(1);this.refresh();return true;},clearSearch:function(btn,e){this.getStore().baseParams.query='';Ext.getCmp(this.config.id+'-search-field').setValue('');this.getBottomToolbar().changePage(1);this.refresh();return true;}});Ext.reg('dbadmin-grid-tables',dbAdmin.grid.Tables);;dbAdmin.window.Data=function(config){config=config||{};if(!config.id){config.id='dbadmin-table-data-window';}
Ext.applyIf(config,{title:_('dbadmin_table')+' `'+config.table+'`',width:1000,maxHeight:800,autoHeight:true,layout:'fit',items:[{xtype:'dbadmin-grid-table-data',fields:config.gridFields,columns:config.gridColumns,class:config.class,package:config.package,baseParams:{action:'mgr/table/getdata',table:config.table,class:config.class,package:config.package}}],buttons:[{text:_('dbadmin_close'),id:'dbadmin-table-data-window-close-btn',handler:function(){this.hide();},scope:this}]});dbAdmin.window.Data.superclass.constructor.call(this,config);};Ext.extend(dbAdmin.window.Data,MODx.Window);Ext.reg('dbadmin-table-data-window',dbAdmin.window.Data);dbAdmin.grid.Data=function(config){config=config||{};if(!config.id){config.id='dbadmin-grid-table-data';}
Ext.applyIf(config,{url:dbAdmin.config.connector_url,viewConfig:{forceFit:true,enableRowBody:true,autoFill:true,showPreview:true,scrollOffset:0},autosave:config.class!='',paging:true,pageSize:10,remoteSort:true});dbAdmin.grid.Data.superclass.constructor.call(this,config);if(config.autosave){this.on('afteredit',this.saveRecord,this);}};Ext.extend(dbAdmin.grid.Data,MODx.grid.Grid,{saveRecord:function(e){var oldValue=e.originalValue,newValue=e.value.replace(/^\s+/g,'');if(oldValue==newValue){e.record.reject();return false;}
var data=Ext.util.JSON.encode(e.record.data);MODx.Ajax.request({url:this.config.url,params:{action:'mgr/table/updatefromgrid',data:data,class:this.config.class,package:this.config.package},listeners:{success:{fn:function(r){e.record.commit();this.refresh();this.fireEvent('afterAutoSave',r);},scope:this},failure:{fn:function(r){e.record.reject();this.fireEvent('afterAutoSave',r);},scope:this}}});},removeRow:function(e){var row=this.getSelectionModel().getSelected();if(typeof(row)!='undefined'){this.menu.record=row.data;}
else if(!this.menu.record){return false;}
var data=Ext.util.JSON.encode(this.menu.record);MODx.msg.confirm({title:_('dbadmin_row_remove'),text:_('dbadmin_row_remove_confirm'),url:this.config.url,params:{action:'mgr/table/removerow',data:data,class:this.config.class,package:this.config.package},listeners:{success:{fn:function(r){this.refresh();},scope:this}}});return true;},onClick:function(e){var elem=e.getTarget();if(elem.nodeName=='BUTTON'){var row=this.getSelectionModel().getSelected();if(typeof(row)!='undefined'){var action=elem.getAttribute('action');if(action=='showMenu'){var ri=this.getStore().find('id',row.id);return this._showMenu(this,ri,e);}
else if(typeof this[action]==='function'){this.menu.record=row.data;return this[action](this,e);}}}
return this.processEvent('click',e);}});Ext.reg('dbadmin-grid-table-data',dbAdmin.grid.Data);;dbAdmin.panel.Home=function(config){config=config||{};Ext.apply(config,{baseCls:'modx-formpanel',layout:'anchor',id:'dbadmin-panel',hideMode:'offsets',items:[{html:'<h2>'+_('dbadmin_menu_desc')+'</h2>',cls:'',style:{margin:'15px 0'}},{xtype:'modx-tabs',id:'dbadmin-tabpanel',defaults:{border:false,autoHeight:true},border:true,hideMode:'offsets',items:[{title:_('dbadmin_tables'),layout:'form',items:[{html:_('dbadmin_intro_msg'),id:'dbadmin-intro-msg',cls:'panel-desc',style:{margin:'15px 15px 0'}},{xtype:'dbadmin-grid-tables',cls:'main-wrapper'}]},{title:_('dbadmin_sql'),layout:'anchor',id:'dbadmin-sql-tab',items:[{html:_('dbadmin_enter_sql_query'),cls:'panel-desc',style:{margin:'15px',padding:'5px !important'}},{xtype:Ext.ComponentMgr.types['modx-texteditor']?'modx-texteditor':'textarea',hideLabel:true,name:'query',style:{margin:'0 15px'},id:'dbadmin-sql-query',height:100,width:'auto',minHeight:100},{xtype:'button',id:'dbadmin-execute-query-btn',text:_('dbadmin_execute'),tooltip:'Ctrl+Enter',tooltipType:'title',style:{margin:'15px 5px 15px 15px'},listeners:{click:function(){var panel=Ext.getCmp('dbadmin-panel'),query=Ext.getCmp('dbadmin-sql-query'),queryVal=query.getValue().replace(/^\s+/g,'');if(!queryVal)return false;panel.el.mask(_('working'));MODx.Ajax.request({url:dbAdmin.config.connector_url,params:{action:"mgr/sql/execute",query:query.getValue()},listeners:{success:{fn:function(r){panel.el.unmask();var val;if(r.select){if(r.number==0){val=_('dbadmin_rows_number')+"0";}else{val=_('dbadmin_rows_number')+r.number+"\n\n"+r.data;}}else{val=_('dbadmin_sql_executed_success');}
Ext.getCmp('dbadmin-sql-query-result').setValue(val);}},failure:{fn:function(r){panel.el.unmask();MODx.msg.alert(_('error'),'Error');Ext.getCmp('dbadmin-sql-query-result').setValue(r.message);}}}});}}},{xtype:'button',id:'dbadmin-clear-btn',text:_('dbadmin_clear'),style:{marginTop:'15px'},listeners:{click:function(){Ext.getCmp('dbadmin-sql-query').setValue("");Ext.getCmp('dbadmin-sql-query-result').setValue("");}}},{html:_('dbadmin_query_result'),cls:'panel-desc',style:{margin:'0 15px'}},{xtype:Ext.ComponentMgr.types['modx-texteditor']?'modx-texteditor':'textarea',hideLabel:true,name:'query_result',style:{margin:'10px 15px'},id:'dbadmin-sql-query-result',height:300,width:'auto',minHeight:200,readOnly:true}]}]}],keys:[{key:Ext.EventObject.ENTER,ctrl:true,scope:this,fn:function(){Ext.getCmp('dbadmin-execute-query-btn').fireEvent('click');}}],listeners:{render:function(p){var msg=Ext.getCmp('dbadmin-intro-msg').html;MODx.Ajax.request({url:dbAdmin.config.connector_url,params:{action:'mgr/package/checkupdate'},listeners:{success:{fn:function(r){msg+=_('dbadmin_package_update');Ext.getCmp('dbadmin-intro-msg').update(msg);},scope:this}}});}}});dbAdmin.panel.Home.superclass.constructor.call(this,config);};Ext.extend(dbAdmin.panel.Home,MODx.Panel);Ext.reg('dbadmin-panel-home',dbAdmin.panel.Home);;dbAdmin.page.Home=function(config){config=config||{};Ext.applyIf(config,{components:[{xtype:'dbadmin-panel-home',renderTo:'dbadmin-panel-home-div'}]});dbAdmin.page.Home.superclass.constructor.call(this,config);};Ext.extend(dbAdmin.page.Home,MODx.Component);Ext.reg('dbadmin-page-home',dbAdmin.page.Home);